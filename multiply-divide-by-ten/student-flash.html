<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Flash Card Practice</title>

  <!-- Handwritten fonts to match main tool -->
  <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@300;400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Schoolbell&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Shadows+Into+Light&display=swap" rel="stylesheet" />

  <style>
    :root {
      --cell-width: 56px;
      --cell-height: 80px;
      --border-color: #d0d4e8;
      --label-color: #555;
      --digit-color: #0066cc;
      --decimal-color: #888;
      --bg-main: #f5f7fb;
      --card-bg: #ffffff;
      --accent-blue: #4c6fff;
      --correct-bg: #d9fdd3;
      --incorrect-bg: #ffd7d7;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #eef1ff, #f5f7fb 50%, #f0f4ff 100%);
      min-height: 100vh;
      padding: 20px;
      color: #222;
    }

    .fc-app {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
      padding: 16px 20px 10px;
      position: relative;
      overflow: hidden;
    }

    /* Header / top bar ------------------------------------------------------ */

    .fc-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 10px;
    }

    .back-btn {
      border: none;
      background: #eef2ff;
      color: #374151;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .back-btn span {
      font-size: 1.1rem;
      margin-right: 4px;
    }

    .fc-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-right: auto;
    }

    /* Mini place value grid ------------------------------------------------- */

    .mini-grid-container {
      margin-top: 6px;
      border-radius: 14px;
      background: #f8f9ff;
      padding: 10px 8px;
      border: 1px solid #d7ddff;
      overflow-x: auto;
      white-space: nowrap;
    }

    .pv-grid {
      display: inline-block;
      border-collapse: collapse;
      white-space: nowrap;
    }

    .pv-row { display: flex; }

    .pv-cell {
      width: var(--cell-width);
      height: var(--cell-height);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff;
      position: relative;
      overflow: hidden;
    }

    .pv-cell.decimal {
      width: 24px;
      min-width: 24px;
      background: #f1f1f1;
      border-left: none;
      border-right: none;
    }

    .pv-labels .pv-cell {
      height: 90px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      border-bottom: 0;
      font-size: 0.65rem;
      color: var(--label-color);
      text-align: center;
      padding: 0 2px;
    }

    .pv-label-text {
      display: inline-block;
      transform: rotate(-90deg);
      transform-origin: center center;
      white-space: nowrap;
    }

    .pv-digits-row .pv-cell {
      border-top: 0;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--digit-color);
    }

    .pv-digits-row .pv-cell.decimal {
      color: var(--decimal-color);
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    .digit-span { display: inline-block; position: relative; z-index: 2; }

    .digit-slide-left-1 { animation: digitSlideLeft1 0.8s ease-out forwards; }
    .digit-slide-right-1 { animation: digitSlideRight1 0.8s ease-out forwards; }
    .digit-slide-left-2 { animation: digitSlideLeft2 0.8s ease-out forwards; }
    .digit-slide-right-2 { animation: digitSlideRight2 0.8s ease-out forwards; }
    .digit-slide-left-3 { animation: digitSlideLeft3 0.8s ease-out forwards; }
    .digit-slide-right-3 { animation: digitSlideRight3 0.8s ease-out forwards; }

    @keyframes digitSlideLeft1 { from { transform: translateX(0); } to { transform: translateX(calc(-1 * var(--cell-width))); } }
    @keyframes digitSlideRight1 { from { transform: translateX(0); } to { transform: translateX(var(--cell-width)); } }
    @keyframes digitSlideLeft2 { from { transform: translateX(0); } to { transform: translateX(calc(-2 * var(--cell-width))); } }
    @keyframes digitSlideRight2 { from { transform: translateX(0); } to { transform: translateX(calc(2 * var(--cell-width))); } }
    @keyframes digitSlideLeft3 { from { transform: translateX(0); } to { transform: translateX(calc(-3 * var(--cell-width))); } }
    @keyframes digitSlideRight3 { from { transform: translateX(0); } to { transform: translateX(calc(3 * var(--cell-width))); } }

    /* Question area --------------------------------------------------------- */

    .question-area {
      margin-top: 18px;
      padding: 18px 20px 18px;
      border-radius: 18px;
      background: #fafbff;
      border: 1px solid #e0e5ff;
    }

    .question-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.95rem;
      color: #6b7280;
      gap: 12px;
      flex-wrap: wrap;
    }

    .question-text {
      text-align: center;
      font-size: 7rem;
      color: #111827;
      font-family: "Schoolbell", "Kalam", "Gloria Hallelujah", "Patrick Hand", "Shadows Into Light", cursive;
      margin-top: 6px;
    }

    .question-subtext {
      text-align: center;
      font-size: 0.95rem;
      color: #6b7280;
      margin-top: 4px;
      min-height: 22px;
    }

    /* Options --------------------------------------------------------------- */

    .options-grid {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }

    .option-card {
      border-radius: 14px;
      border: 2px solid #e5e7f5;
      background: #ffffff;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: box-shadow 0.12s ease, transform 0.08s ease, border-color 0.12s ease, background 0.12s ease;
      position: relative;
      text-align: left;
    }

    .option-card:hover:not(.disabled) {
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
      border-color: #c7d2fe;
    }

    .option-card.disabled {
      cursor: default;
      opacity: 0.90;
      box-shadow: none;
      transform: none;
    }

    .option-label {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 2px solid #a855f7;
      color: #7e22ce;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .option-value {
      font-size: 3rem;
      font-weight: 600;
      color: #111827;
      font-family: "Schoolbell", "Kalam", "Gloria Hallelujah", "Patrick Hand", "Shadows Into Light", cursive;
    }

    .option-card.correct { background: var(--correct-bg); border-color: #22c55e; }
    .option-card.incorrect { background: var(--incorrect-bg); border-color: #f97373; }

    .option-mark {
      position: absolute;
      right: 10px;
      bottom: 6px;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .option-mark.correct { color: #16a34a; }
    .option-mark.incorrect { color: #ef4444; }

    /* Typed answer block ---------------------------------------------------- */

    .typed-answer {
      margin-top: 18px;
      border-radius: 14px;
      border: 2px solid #e5e7f5;
      background: #ffffff;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .typed-label {
      font-family: "Schoolbell", "Kalam", "Gloria Hallelujah", "Patrick Hand", "Shadows Into Light", cursive;
      font-size: 2.2rem;
      color: #111827;
    }

    .typed-input {
      width: min(340px, 85vw);
      padding: 10px 14px;
      font-size: 1.4rem;
      border-radius: 12px;
      border: 2px solid #d7ddff;
      outline: none;
      background: #fbfbff;
    }
    .typed-input:focus { border-color: #93c5fd; box-shadow: 0 0 0 4px rgba(147,197,253,0.25); }

    .enter-btn {
      border: none;
      border-radius: 999px;
      background: var(--accent-blue);
      color: #ffffff;
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
      white-space: nowrap;
    }
    .enter-btn:disabled { opacity: 0.45; cursor: default; box-shadow: none; }

    .typed-answer.correct {
      background: var(--correct-bg);
      border-color: #22c55e;
    }
    .typed-answer.incorrect {
      background: var(--incorrect-bg);
      border-color: #f97373;
    }

    .typed-feedback {
      width: 100%;
      text-align: center;
      margin-top: 10px;
      font-size: 1rem;
      color: #4b5563;
    }

    /* Bottom controls ------------------------------------------------------- */

    .bottom-controls {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      color: #6b7280;
      gap: 12px;
    }

    #progressBarOuter {
      flex: 1;
      height: 8px;
      border-radius: 999px;
      background: #e5e7f5;
      overflow: hidden;
    }

    #progressBarInner {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #4f46e5, #22c55e);
      border-radius: inherit;
      transition: width 0.25s ease-out;
    }

    #nextBtn {
      border: none;
      border-radius: 999px;
      background: var(--accent-blue);
      color: #ffffff;
      padding: 8px 22px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4);
      min-width: 120px;
    }

    #nextBtn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    /* Banner footer --------------------------------------------------------- */

    .tool-footer {
      margin-top: 12px;
      padding: 10px 8px 6px;
      text-align: center;
      color: #6b7280;
      font-size: 0.92rem;
      border-top: 1px solid #e5e7f5;
    }

    .tool-footer a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 700;
    }

    .tool-footer a:hover { text-decoration: underline; }

    /* Results panel --------------------------------------------------------- */

    #resultsPanel {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #resultsCard {
      background: #ffffff;
      border-radius: 18px;
      padding: 24px 26px 20px;
      max-width: 460px;
      width: 95%;
      text-align: center;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.25);
    }

    #resultsCard h2 {
      font-size: 1.7rem;
      margin-bottom: 8px;
    }

    #resultsLevel {
      display: inline-block;
      margin: 4px 0 10px;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.95rem;
      background: #eef2ff;
      color: #111827;
      border: 1px solid #d7ddff;
    }

    #resultsScore {
      font-size: 2.4rem;
      font-weight: 700;
      color: #111827;
      margin: 8px 0;
    }

    #resultsSummary {
      font-size: 1rem;
      color: #4b5563;
      margin-bottom: 14px;
    }

    #resultsMessage {
      font-size: 1rem;
      color: #111827;
      margin-bottom: 18px;
    }

    .results-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .results-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 18px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
    }

    #playAgainBtn { background: var(--accent-blue); color: #ffffff; }
    #closeResultsBtn { background: #e5e7f5; color: #111827; }

    .hidden { display: none !important; }

    /* Level chooser overlay ------------------------------------------------- */

    #levelPanel {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 55;
      padding: 14px;
    }

    #levelCard {
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 18px 14px;
      max-width: 560px;
      width: 95%;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.25);
    }

    #levelCard h2 {
      font-size: 1.25rem;
      margin-bottom: 12px;
      color: #111827;
    }

    .level-list { display: flex; flex-direction: column; gap: 10px; }

    .level-row {
      border-radius: 14px;
      border: 1px solid #e5e7f5;
      padding: 12px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .level-left { display: flex; flex-direction: column; gap: 2px; min-width: 0; }

    .level-name {
      font-weight: 900;
      color: #111827;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .level-desc { color: #6b7280; font-size: 0.9rem; }

    .level-start {
      border: none;
      border-radius: 999px;
      background: var(--accent-blue);
      color: #ffffff;
      padding: 8px 16px;
      font-size: 0.95rem;
      font-weight: 800;
      cursor: pointer;
      flex-shrink: 0;
    }

    .lvl-green  { background: #eaffef; border-color: #b7f5c5; }
    .lvl-blue   { background: #eef4ff; border-color: #c7dbff; }
    .lvl-yellow { background: #fff8d9; border-color: #ffe8a3; }
    .lvl-orange { background: #fff0e2; border-color: #ffd1a8; }
    .lvl-red    { background: #ffe8e8; border-color: #ffbcbc; }

    /* Confetti -------------------------------------------------------------- */

    #confettiContainer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 60;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      width: 8px;
      height: 16px;
      border-radius: 2px;
      opacity: 0.9;
      animation-name: confettiFall;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }

    @keyframes confettiFall {
      0%   { transform: translate3d(0, -100vh, 0) rotateZ(0deg); }
      100% { transform: translate3d(0, 100vh, 0) rotateZ(360deg); }
    }

    @media (max-width: 720px) {
      .fc-app { padding: 12px 12px 10px; }
      .fc-header { align-items: flex-start; flex-direction: column; }
      .question-text { font-size: 2.4rem; }
      .options-grid { grid-template-columns: 1fr; }
      .typed-label { font-size: 1.6rem; }
      .typed-input { font-size: 1.2rem; }
    }
  </style>
</head>

<body>
  <div class="fc-app">
    <header class="fc-header">
      <button class="back-btn" type="button" id="backBtn">
        <span>←</span> Back
      </button>
      <div class="fc-title">Student Flash Card Practice</div>
    </header>

    <!-- Mini place value grid -->
    <section class="mini-grid-container">
      <div id="miniPlaceValue"></div>
    </section>

    <!-- Question -->
    <section class="question-area" aria-live="polite">
      <div class="question-top-row">
        <span id="questionCounter">Question —</span>
        <span id="modeLabelText">Level: —</span>
      </div>

      <div id="questionText" class="question-text">Choose a level to begin</div>
      <div id="questionSubtext" class="question-subtext"></div>

      <!-- Multiple choice options -->
      <div class="options-grid" id="optionsGrid"></div>

      <!-- Typed answer area (hidden unless Q11–Q15) -->
      <div id="typedAnswerWrap" class="hidden">
        <div id="typedAnswerBox" class="typed-answer">
          <div class="typed-label">Enter answer here</div>
          <input id="typedInput" class="typed-input" inputmode="decimal" autocomplete="off" />
          <button id="enterBtn" class="enter-btn" type="button">Enter</button>
          <div id="typedFeedback" class="typed-feedback"></div>
        </div>
      </div>

      <div class="bottom-controls">
        <div id="progressBarOuter">
          <div id="progressBarInner"></div>
        </div>
        <button id="nextBtn" type="button" disabled>Next</button>
      </div>
    </section>

    <!-- Banner footer -->
    <div class="tool-footer">
      This tool and more can be found at
      <a href="https://www.millsmathstools.com" target="_blank" rel="noopener noreferrer">www.millsmathstools.com</a>
    </div>

    <!-- Level chooser overlay -->
    <div id="levelPanel" aria-modal="true" role="dialog">
      <div id="levelCard">
        <h2>Choose your level</h2>
        <div class="level-list">
          <div class="level-row lvl-green">
            <div class="level-left">
              <div class="level-name">Level 1</div>
              <div class="level-desc">× / ÷ 10</div>
            </div>
            <button class="level-start" type="button" data-level="ten">Start</button>
          </div>

          <div class="level-row lvl-blue">
            <div class="level-left">
              <div class="level-name">Level 2</div>
              <div class="level-desc">× / ÷ 100</div>
            </div>
            <button class="level-start" type="button" data-level="hundred">Start</button>
          </div>

          <div class="level-row lvl-yellow">
            <div class="level-left">
              <div class="level-name">Level 3</div>
              <div class="level-desc">× / ÷ 1000</div>
            </div>
            <button class="level-start" type="button" data-level="thousand">Start</button>
          </div>

          <div class="level-row lvl-orange">
            <div class="level-left">
              <div class="level-name">Level 4</div>
              <div class="level-desc">Mixed</div>
            </div>
            <button class="level-start" type="button" data-level="mixed">Start</button>
          </div>

          <div class="level-row lvl-red">
            <div class="level-left">
              <div class="level-name">Level 5</div>
              <div class="level-desc">Reverse challenge</div>
            </div>
            <button class="level-start" type="button" data-level="reverse">Start</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results overlay -->
    <div id="resultsPanel" class="hidden" aria-modal="true" role="dialog">
      <div id="resultsCard">
        <h2>Nice work!</h2>
        <div id="resultsLevel">Level: —</div>
        <div id="resultsScore">0 / 15</div>
        <div id="resultsSummary"></div>
        <div id="resultsMessage"></div>
        <div class="results-buttons">
          <button id="playAgainBtn" class="results-btn">Play again</button>
          <button id="closeResultsBtn" class="results-btn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div id="confettiContainer"></div>

<script>
  /**********************
   * CONFIG & CONSTANTS *
   **********************/

  const TOTAL_QUESTIONS = 15;
  const MC_COUNT = 10; // first 10 are multiple choice, last 5 are typed

  const positivePlaces = [
    "trillions","hundred-billions","ten-billions","billions","hundred-millions",
    "ten-millions","millions","hundred-thousands","ten-thousands","thousands",
    "hundreds","tens","ones"
  ];
  const negativePlaces = [
    "tenths","hundredths","thousandths","ten-thousandths","hundred-thousandths","millionths"
  ];

  const MAX_LEFT_DIGITS  = positivePlaces.length;
  const MAX_RIGHT_DIGITS = negativePlaces.length;
  const MAX_INT_VALUE    = Math.pow(10, MAX_LEFT_DIGITS);
  const MIN_POS_VALUE    = Math.pow(10, -MAX_RIGHT_DIGITS);

  const operationsPool = [
    { steps: 1, mult: true,  label: "× 10"   },
    { steps: 1, mult: false, label: "÷ 10"   },
    { steps: 2, mult: true,  label: "× 100"  },
    { steps: 2, mult: false, label: "÷ 100"  },
    { steps: 3, mult: true,  label: "× 1000" },
    { steps: 3, mult: false, label: "÷ 1000" }
  ];

  const LEVEL_LABELS = {
    ten: "Level 1: × / ÷ 10",
    hundred: "Level 2: × / ÷ 100",
    thousand: "Level 3: × / ÷ 1000",
    mixed: "Level 4: Mixed",
    reverse: "Level 5: Reverse challenge"
  };

  /********************
   * DOM REFERENCES   *
   ********************/

  const backBtn       = document.getElementById("backBtn");
  const miniPV        = document.getElementById("miniPlaceValue");
  const questionText  = document.getElementById("questionText");
  const questionCounter = document.getElementById("questionCounter");
  const modeLabelText = document.getElementById("modeLabelText");
  const questionSubtext = document.getElementById("questionSubtext");

  const optionsGrid   = document.getElementById("optionsGrid");
  const typedAnswerWrap = document.getElementById("typedAnswerWrap");
  const typedAnswerBox  = document.getElementById("typedAnswerBox");
  const typedInput    = document.getElementById("typedInput");
  const enterBtn      = document.getElementById("enterBtn");
  const typedFeedback = document.getElementById("typedFeedback");

  const nextBtn       = document.getElementById("nextBtn");
  const progressBarInner = document.getElementById("progressBarInner");

  const levelPanel    = document.getElementById("levelPanel");
  const levelStartBtns= document.querySelectorAll(".level-start");

  const resultsPanel  = document.getElementById("resultsPanel");
  const resultsLevel  = document.getElementById("resultsLevel");
  const resultsScore  = document.getElementById("resultsScore");
  const resultsSummary= document.getElementById("resultsSummary");
  const resultsMessage= document.getElementById("resultsMessage");
  const playAgainBtn  = document.getElementById("playAgainBtn");
  const closeResultsBtn = document.getElementById("closeResultsBtn");
  const confettiContainer = document.getElementById("confettiContainer");

  /********************
   * STATE            *
   ********************/

  let currentMode = null; // chosen from chooser
  let currentQuestionIndex = 0; // 0-based
  let correctCount = 0;
  let currentQuestion = null; // {original, final, operation, prompt, options[], correctIndex, answerValue}
  let hasAnsweredCurrent = false;
  let currentQuestionType = "mc"; // "mc" | "typed"

  /********************
   * UTILITIES        *
   ********************/

  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function isInPlaceValueRange(value) {
    if (value >= MAX_INT_VALUE) return false;
    if (value < MIN_POS_VALUE) return false;
    return true;
  }

  function normalizeValue(v) {
    if (!isFinite(v)) return v;
    const INT_EPS = 1e-12;
    const nearestInt = Math.round(v);
    if (nearestInt !== 0 && Math.abs(v - nearestInt) < INT_EPS) return nearestInt;
    return v;
  }

  function formatNumber(value) {
    let s = value.toFixed(6);
    s = s.replace(/\.?0+$/, "");
    if (s === "") s = "0";

    let [intPart, fracPart = ""] = s.split(".");
    intPart = intPart.replace(/^0+/, "") || "0";
    intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    return fracPart ? `${intPart}.${fracPart}` : intPart;
  }

  function approxEqual(a, b) {
    return Math.abs(a - b) < 1e-10;
  }

  function parseStudentNumber(raw) {
    // Allow spaces as thousands separators; allow comma as decimal if a student uses it
    if (typeof raw !== "string") return NaN;
    const cleaned = raw
      .trim()
      .replace(/\s+/g, "")   // remove spaces
      .replace(",", ".");   // comma decimal -> dot
    if (cleaned === "") return NaN;
    return Number(cleaned);
  }

  /********************
   * MINI GRID RENDER *
   ********************/

  function getDigitInfoForGrid(value) {
    let s = value.toFixed(MAX_RIGHT_DIGITS);
    if (!s.includes(".")) s += ".";
    let [intPart, fracPart] = s.split(".");
    intPart = intPart.replace(/^0+/, "") || "0";
    if (!fracPart) fracPart = "";
    if (fracPart.length < MAX_RIGHT_DIGITS) {
      fracPart = fracPart.padEnd(MAX_RIGHT_DIGITS, "0");
    } else if (fracPart.length > MAX_RIGHT_DIGITS) {
      fracPart = fracPart.slice(0, MAX_RIGHT_DIGITS);
    }
    return { leftDigits: intPart.split(""), rightDigits: fracPart.split("") };
  }

  function renderMiniGrid(value) {
    if (value == null || !isInPlaceValueRange(value)) {
      miniPV.innerHTML =
        "<em style='color:#6b7280;font-size:0.9rem;'>Digits shown here when a question loads.</em>";
      return;
    }

    const { leftDigits, rightDigits } = getDigitInfoForGrid(value);

    const leftCells  = new Array(positivePlaces.length).fill("");
    const rightCells = new Array(negativePlaces.length).fill("");

    for (let i = 0; i < leftDigits.length; i++) {
      const targetIndex = leftCells.length - 1 - i;
      if (targetIndex < 0) break;
      leftCells[targetIndex] = leftDigits[leftDigits.length - 1 - i];
    }

    for (let i = 0; i < Math.min(rightDigits.length, rightCells.length); i++) {
      rightCells[i] = rightDigits[i];
    }

    let html = '<div class="pv-grid">';
    html += '<div class="pv-row pv-labels">';
    positivePlaces.forEach(name => {
      html += `<div class="pv-cell"><span class="pv-label-text">${name}</span></div>`;
    });
    html += '<div class="pv-cell decimal"></div>';
    negativePlaces.forEach(name => {
      html += `<div class="pv-cell"><span class="pv-label-text">${name}</span></div>`;
    });
    html += '</div>';

    html += '<div class="pv-row pv-digits-row">';
    leftCells.forEach(d => {
      html += `<div class="pv-cell">${d ? `<span class="digit-span">${d}</span>` : ""}</div>`;
    });
    html += '<div class="pv-cell decimal">.</div>';
    rightCells.forEach(d => {
      html += `<div class="pv-cell">${d ? `<span class="digit-span">${d}</span>` : ""}</div>`;
    });
    html += '</div>';

    html += '</div>';

    miniPV.innerHTML = html;
    miniPV.parentElement.scrollLeft = 0;
  }

  function animateMiniGridSlide(steps, isMultiply, callback) {
    const spans = miniPV.querySelectorAll(".digit-span");
    if (!spans.length || steps <= 0) {
      if (typeof callback === "function") callback();
      return;
    }
    const direction = isMultiply ? "left" : "right";
    const cls = `digit-slide-${direction}-${steps}`;
    spans.forEach(s => s.classList.add(cls));
    const duration = 900;
    setTimeout(() => {
      spans.forEach(s => s.classList.remove(
        "digit-slide-left-1","digit-slide-right-1",
        "digit-slide-left-2","digit-slide-right-2",
        "digit-slide-left-3","digit-slide-right-3"
      ));
      if (typeof callback === "function") callback();
    }, duration);
  }

  /********************
   * QUESTION GENERATION
   ********************/

  function chooseOperationForMode(mode) {
    const candidates = [];
    if (mode === "ten") {
      operationsPool.forEach(op => { if (op.steps === 1) candidates.push(op); });
    } else if (mode === "hundred") {
      operationsPool.forEach(op => { if (op.steps === 2) candidates.push(op); });
    } else if (mode === "thousand") {
      operationsPool.forEach(op => { if (op.steps === 3) candidates.push(op); });
    } else if (mode === "mixed" || mode === "reverse") {
      operationsPool.forEach(op => candidates.push(op));
    }
    const pick = candidates[randInt(0, candidates.length - 1)];
    return { steps: pick.steps, mult: pick.mult, label: pick.label };
  }

  function generateOriginalAndFinal(op, reverseMode) {
    const maxAttempts = 150;
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
      const base  = randInt(1, 999);
      const exp   = randInt(-2, 3);
      let value   = base * Math.pow(10, exp);
      value       = normalizeValue(parseFloat(value.toFixed(3)));

      if (!isInPlaceValueRange(value)) continue;

      let original, final;
      if (!reverseMode) {
        original = value;
        const factor = Math.pow(10, op.steps);
        final = normalizeValue(op.mult ? original * factor : original / factor);
      } else {
        const factor = Math.pow(10, op.steps);
        original = op.mult
          ? normalizeValue(value / factor)
          : normalizeValue(value * factor);
        final = value;
      }

      if (!isFinite(original) || !isFinite(final) || original <= 0 || final <= 0) continue;
      if (!isInPlaceValueRange(original) || !isInPlaceValueRange(final)) continue;

      return { original, final };
    }

    const original = 148;
    const factor = Math.pow(10, op.steps);
    const final = op.mult ? original * factor : original / factor;
    return { original, final };
  }

  function generateDistractors(original, correctValue, correctOp) {
    const distractors = [];
    const used = [correctValue];

    function addCandidate(val) {
      if (!isFinite(val) || val <= 0) return;
      val = normalizeValue(val);
      if (!isInPlaceValueRange(val)) return;
      if (used.some(x => approxEqual(x, val))) return;
      used.push(val);
      distractors.push(val);
    }

    operationsPool.forEach(op => {
      if (op.steps === correctOp.steps && op.mult === correctOp.mult) return;
      const factor = Math.pow(10, op.steps);
      const val = normalizeValue(op.mult ? original * factor : original / factor);
      addCandidate(val);
    });

    while (distractors.length < 3) {
      const mag = Math.max(0, Math.floor(Math.log10(correctValue)) - 1);
      const deltaBase = Math.pow(10, mag);
      const sign = Math.random() < 0.5 ? -1 : 1;
      const delta = deltaBase * (0.5 + Math.random());
      const candidate = normalizeValue(correctValue + sign * delta);
      addCandidate(candidate);
      if (!isFinite(candidate) || candidate <= 0) break;
    }

    return distractors.slice(0, 3).map(v => v);
  }

  function generateQuestion() {
    const op = chooseOperationForMode(currentMode);
    const reverseMode = currentMode === "reverse";
    const { original, final } = generateOriginalAndFinal(op, reverseMode);

    let prompt, answerValue;
    const sign = op.mult ? "×" : "÷";
    const factor = Math.pow(10, op.steps);

    if (!reverseMode) {
      prompt = `${formatNumber(original)} ${sign} ${factor} = ?`;
      answerValue = final;
    } else {
      prompt = `? ${sign} ${factor} = ${formatNumber(final)}`;
      answerValue = original;
    }

    const distractorsValues = generateDistractors(original, answerValue, op);

    const allValues = [answerValue, ...distractorsValues];
    while (allValues.length < 4) {
      const mag = Math.max(0, Math.floor(Math.log10(answerValue)) - 1);
      const delta = Math.pow(10, mag);
      const candidate = normalizeValue(answerValue + delta * (allValues.length));
      allValues.push(candidate);
    }

    const indices = [0, 1, 2, 3];
    for (let i = indices.length - 1; i > 0; i--) {
      const j = randInt(0, i);
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }

    const labels = ["A", "B", "C", "D"];
    const options = indices.map((idx, outIdx) => ({
      label: labels[outIdx],
      value: allValues[idx]
    }));

    const correctIndex = options.findIndex(o => approxEqual(o.value, answerValue));

    return {
      original,
      final,
      operation: op,
      prompt,
      options,
      correctIndex,
      answerValue
    };
  }

  /********************
   * UI MODE SWITCH   *
   ********************/

  function setQuestionTypeForIndex(idx0based) {
    currentQuestionType = (idx0based < MC_COUNT) ? "mc" : "typed";
  }

  function resetAnswerUI() {
    // MC
    optionsGrid.innerHTML = "";
    optionsGrid.classList.remove("hidden");

    // Typed
    typedAnswerWrap.classList.add("hidden");
    typedAnswerBox.classList.remove("correct", "incorrect");
    typedInput.value = "";
    typedInput.disabled = false;
    enterBtn.disabled = false;
    typedFeedback.textContent = "";
    questionSubtext.textContent = "";
  }

  /********************
   * RENDER QUESTION  *
   ********************/

  function renderQuestion() {
    hasAnsweredCurrent = false;
    nextBtn.disabled = true;
    resetAnswerUI();

    setQuestionTypeForIndex(currentQuestionIndex);

    const qNum = currentQuestionIndex + 1;
    questionCounter.textContent = `Question ${qNum} of ${TOTAL_QUESTIONS}`;
    modeLabelText.textContent = `Level: ${LEVEL_LABELS[currentMode] || "—"}`;

    questionText.textContent = currentQuestion.prompt;

    // Mini-grid starts at ORIGINAL number
    renderMiniGrid(currentQuestion.original);

    // Progress
    const progress = (currentQuestionIndex / TOTAL_QUESTIONS) * 100;
    progressBarInner.style.width = `${progress}%`;

    nextBtn.textContent = (currentQuestionIndex === TOTAL_QUESTIONS - 1)
      ? "Show results"
      : "Next";

    if (currentQuestionType === "mc") {
      typedAnswerWrap.classList.add("hidden");
      optionsGrid.classList.remove("hidden");

      const letterOrder = ["A", "B", "C", "D"];
      currentQuestion.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "option-card";
        btn.dataset.index = idx.toString();

        const labelSpan = document.createElement("span");
        labelSpan.className = "option-label";
        labelSpan.textContent = letterOrder[idx];

        const valueSpan = document.createElement("span");
        valueSpan.className = "option-value";
        valueSpan.textContent = formatNumber(opt.value);

        btn.appendChild(labelSpan);
        btn.appendChild(valueSpan);

        btn.addEventListener("click", () => handleOptionClick(idx));
        optionsGrid.appendChild(btn);
      });

    } else {
      // Typed mode
      optionsGrid.classList.add("hidden");
      typedAnswerWrap.classList.remove("hidden");

      // focus input on typed questions
      setTimeout(() => typedInput.focus(), 0);
    }
  }

  function lockInAndAnimate(isCorrect, chosenIndexForMC = null) {
    if (isCorrect) correctCount += 1;

    // Slide digits THEN update mini-grid to FINAL
    animateMiniGridSlide(
      currentQuestion.operation.steps,
      currentQuestion.operation.mult,
      () => renderMiniGrid(currentQuestion.final)
    );

    nextBtn.disabled = false;
  }

  function handleOptionClick(index) {
    if (hasAnsweredCurrent) return;
    hasAnsweredCurrent = true;

    const correctIndex = currentQuestion.correctIndex;
    const optionCards = optionsGrid.querySelectorAll(".option-card");

    optionCards.forEach((card, idx) => {
      card.classList.add("disabled");
      const mark = document.createElement("div");
      mark.className = "option-mark";

      if (idx === correctIndex) {
        card.classList.add("correct");
        mark.classList.add("correct");
        mark.textContent = "✓";
      }
      if (idx === index && idx !== correctIndex) {
        card.classList.add("incorrect");
        mark.classList.add("incorrect");
        mark.textContent = "✗";
      }
      if (idx === correctIndex || idx === index) {
        card.appendChild(mark);
      }
    });

    lockInAndAnimate(index === correctIndex, index);
  }

  function submitTypedAnswer() {
    if (hasAnsweredCurrent) return;

    const studentVal = parseStudentNumber(typedInput.value);
    if (!isFinite(studentVal)) {
      typedFeedback.textContent = "Type a number, then press Enter.";
      typedFeedback.style.color = "#b45309";
      typedInput.focus();
      return;
    }

    hasAnsweredCurrent = true;

    const correctVal = currentQuestion.answerValue;
    const isCorrect = approxEqual(studentVal, correctVal);

    typedAnswerBox.classList.remove("correct", "incorrect");
    typedAnswerBox.classList.add(isCorrect ? "correct" : "incorrect");

    typedInput.disabled = true;
    enterBtn.disabled = true;

    if (isCorrect) {
      typedFeedback.textContent = "✓ Correct!";
      typedFeedback.style.color = "#166534";
    } else {
      typedFeedback.textContent = `✗ Not quite. Correct answer: ${formatNumber(correctVal)}`;
      typedFeedback.style.color = "#991b1b";
    }

    lockInAndAnimate(isCorrect);
  }

  /********************
   * GAME FLOW        *
   ********************/

  function startNewGame() {
    currentQuestionIndex = 0;
    correctCount = 0;
    currentQuestion = generateQuestion();
    renderQuestion();
    progressBarInner.style.width = "0%";
  }

  function goToNextQuestion() {
    if (currentQuestionIndex >= TOTAL_QUESTIONS - 1) {
      showResults();
      return;
    }
    currentQuestionIndex += 1;
    currentQuestion = generateQuestion();
    renderQuestion();
  }

  function showResults() {
    resultsLevel.textContent = `Level completed: ${LEVEL_LABELS[currentMode] || "—"}`;

    const scoreText = `${correctCount} / ${TOTAL_QUESTIONS}`;
    resultsScore.textContent = scoreText;
    resultsSummary.textContent = `You answered ${correctCount} questions correctly.`;

    const pct = (correctCount / TOTAL_QUESTIONS) * 100;
    let message;
    if (pct === 100) {
      message = "Perfect score! Decimal place champion!";
    } else if (pct >= 80) {
      message = "Awesome effort. The decimal point is right where you want it.";
    } else if (pct >= 50) {
      message = "Nice start. Keep practising moving those digits.";
    } else {
      message = "Good try. Have another go and watch how the digits slide.";
    }
    resultsMessage.textContent = message;

    if (pct >= 80) {
      launchConfetti();
    }

    resultsPanel.classList.remove("hidden");
  }

  function hideResults() {
    resultsPanel.classList.add("hidden");
  }

  function showLevelChooser() {
    levelPanel.classList.remove("hidden");
  }

  function hideLevelChooser() {
    levelPanel.classList.add("hidden");
  }

  function resetToChooser() {
    // clear game UI and show chooser
    currentMode = null;
    currentQuestionIndex = 0;
    correctCount = 0;
    currentQuestion = null;
    hasAnsweredCurrent = false;

    questionCounter.textContent = "Question —";
    modeLabelText.textContent = "Level: —";
    questionText.textContent = "Choose a level to begin";
    questionSubtext.textContent = "";
    optionsGrid.innerHTML = "";
    typedInput.value = "";
    typedFeedback.textContent = "";
    typedAnswerWrap.classList.add("hidden");
    nextBtn.disabled = true;
    progressBarInner.style.width = "0%";

    renderMiniGrid(null);
    hideResults();
    showLevelChooser();
  }

  /********************
   * CONFETTI         *
   ********************/

  function launchConfetti() {
    if (!confettiContainer) return;
    const colors = ["#f97316","#facc15","#22c55e","#0ea5e9","#6366f1","#ec4899"];
    const count = 140;
    for (let i = 0; i < count; i++) {
      const piece = document.createElement("div");
      piece.className = "confetti-piece";
      piece.style.backgroundColor = colors[i % colors.length];

      const duration = 2 + Math.random() * 2;
      const delay = Math.random() * 0.5;

      piece.style.animationDuration = duration.toFixed(2) + "s";
      piece.style.animationDelay = delay.toFixed(2) + "s";
      piece.style.left = Math.random() * 100 + "%";

      confettiContainer.appendChild(piece);
      setTimeout(() => {
        if (piece.parentNode === confettiContainer) {
          confettiContainer.removeChild(piece);
        }
      }, (duration + delay + 0.6) * 1000);
    }
  }

  /********************
   * EVENT LISTENERS  *
   ********************/

  // Level selection
  levelStartBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const level = btn.dataset.level;
      currentMode = level;
      hideLevelChooser();
      startNewGame();
    });
  });

  nextBtn.addEventListener("click", () => {
    if (!hasAnsweredCurrent) return;
    goToNextQuestion();
  });

  enterBtn.addEventListener("click", () => {
    if (currentQuestionType !== "typed") return;
    submitTypedAnswer();
  });

  // Enter key behaviour:
  // - If chooser/results open: ignore
  // - If typed + not answered: submit
  // - If answered (either type): next
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Enter") return;

    if (!levelPanel.classList.contains("hidden")) return;
    if (!resultsPanel.classList.contains("hidden")) return;

    if (currentQuestionType === "typed" && !hasAnsweredCurrent) {
      e.preventDefault();
      submitTypedAnswer();
      return;
    }

    if (hasAnsweredCurrent && !nextBtn.disabled) {
      e.preventDefault();
      nextBtn.click();
    }
  });

  backBtn.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  // Play again -> return to chooser
  playAgainBtn.addEventListener("click", () => {
    resetToChooser();
  });

  closeResultsBtn.addEventListener("click", () => {
    hideResults();
  });

  /********************
   * INITIALISE       *
   ********************/

  renderMiniGrid(null);
  showLevelChooser();
</script>

</body>
</html>
